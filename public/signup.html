<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Signup — SMS</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--accent:#2b7cff;--muted:#666;}
    body{font-family:Inter,Segoe UI,Arial,sans-serif;background:#f3f5f7;padding:24px}
    .auth-container{width:420px;margin:48px auto;padding:22px;background:#fff;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,0.06)}
    h2{text-align:center;margin:0 0 14px}
    input{width:100%;padding:10px 12px;margin:8px 0;border-radius:6px;border:1px solid #ddd;box-sizing:border-box}
    button{width:100%;padding:10px;border-radius:6px;border:none;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
    .muted{color:var(--muted);text-align:center;margin-top:12px}
    .error{color:#b00020;text-align:center;margin-top:8px;min-height:20px}
    .helper{font-size:13px;color:#444;margin-top:6px}
    a{color:var(--accent)}
  </style>
</head>
<body>
  <div class="auth-container" role="main" aria-labelledby="signuptitle">
    <h2 id="signuptitle">Create an account</h2>

    <input id="name" placeholder="Name (optional)" autocomplete="name" maxlength="50" />
    <input id="email" type="email" placeholder="Email" autocomplete="email" required />
    <input id="password" type="password" placeholder="Password (min 8 chars, 1 uppercase, 1 number)" autocomplete="new-password" required minlength="8" />
    <button id="signupBtn" type="button">Signup</button>

    <div class="error" id="err"></div>
    <div class="muted">Already have an account? <a href="login.html">Login</a></div>
  </div>

<script>
  const errEl = document.getElementById('err');
  function showError(msg) {
    errEl.textContent = msg || '';
    if (msg) setTimeout(()=> errEl.textContent = '', 5000);
  }

  // Email validation regex
  function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
  }

  // Password strength validation
  function isValidPassword(password) {
    // At least 8 chars, 1 uppercase, 1 lowercase, 1 number
    const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d@$!%*?&]{8,}$/;
    return passwordRegex.test(password);
  }

  async function doSignup() {
    showError('');
    const name = document.getElementById('name').value.trim();
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;

    if (!email || !password) return showError('Email and password are required');
    if (!isValidEmail(email)) return showError('Please enter a valid email address');
    if (!isValidPassword(password)) return showError('Password must be at least 8 characters with 1 uppercase, 1 lowercase, and 1 number');

    // Sanitize name input
    const sanitizedName = name.replace(/[<>]/g, '').substring(0, 50);

    try {
      const res = await fetch('/api/auth/signup', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ name: sanitizedName, email, password })
      });

      const data = await res.json().catch(()=> ({}));
      if (!res.ok) {
        const msg = (data && (data.message || data.error)) || 'Signup failed';
        return showError(msg);
      }

      // try to auto-login on successful signup if API returned token
      if (data.token) localStorage.setItem('token', data.token);

      const user = data.user || data;
      const uid = user && (user.id || user._id || user.userId) || '';
      const uname = user && (user.name || user.username) || '';

      if (uid) localStorage.setItem('userId', uid);
      if (uname) localStorage.setItem('username', uname);
      if (user) localStorage.setItem('user', JSON.stringify(user));

      // redirect to app
      window.location.href = '/index.html';
    } catch (err) {
      console.error('Signup error', err);
      showError('Network error — try again');
    }
  }

  document.getElementById('signupBtn').addEventListener('click', doSignup);
  ['name','email','password'].forEach(id => {
    document.getElementById(id).addEventListener('keydown', e => { if (e.key === 'Enter') doSignup(); });
  });
</script>
</body>
</html>
